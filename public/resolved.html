<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Resolved Page</title>
    <style>
        /* General Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        h2 {
            color: #333;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ccc;
        }

        th {
            background-color: #f2f2f2;
        }

        a {
            color: #007bff;
            text-decoration: none;
        }

        button {
            margin: 5px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .print-button {
            background: none;
            border: none;
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
        }

        .print-button:hover {
            color: #0056b3;
        }

        .error-message {
            color: red;
        }

        .search-bar {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: center;
        }

        .search-bar input, .search-bar select {
            margin-right: 10px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 200px;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Resolution Page</h2>
        <h2>Resolved</h2> <!-- Updated heading to show "Resolved" records -->
        <!-- Search Bar -->
        <div class="search-bar">
            <input type="text" id="searchResolutionId" placeholder="Search Resolution ID" oninput="searchTable('resolutionId')">
            <input type="text" id="searchDate" placeholder="Search Date" oninput="searchTable('date')">
            <input type="text" id="searchTechnician" placeholder="Search Technician" oninput="searchTable('technician')">
            <input type="text" id="searchPartNumber" placeholder="Search Part Number" oninput="searchTable('partNumber')">
            <select id="searchProductLine" onchange="searchTable('productLine')">
                <option value="">Search Product Line</option>
                <option value="Smart">Smart</option>
                <option value="Warrior">Warrior</option>
            </select>
            <input type="text" id="searchBatchNumber" placeholder="Search Batch Number" oninput="searchTable('batchNumber')">
            <input type="text" id="searchQuantity" placeholder="Search Quantity" oninput="searchTable('quantity')">
            <select id="searchIssue" onchange="searchTable('issue')">
                <option value="">Search Issue</option>
                <option value="Power">Power</option>
                <option value="Logic">Logic</option>
                <option value="Radio">Radio</option>
                <option value="Miscellaneous">Miscellaneous</option>
            </select>
        </div>
        <!-- Records Table -->
        <table id="ResolvedRecordsTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>Resolution ID</th>
                    <th>Date</th>
                    <th>Technician</th>
                    <th>Part Number</th>
                    <th>Product Line</th>
                    <th>Batch Number</th>
                    <th>Quantity</th>
                    <th>Issue</th>
                    <th>Issue Comments</th>
                    <th>Resolution Steps</th>
                </tr>
            </thead>
            <tbody>
                <!-- Records will be populated here -->
            </tbody>
        </table>
        <!-- Pagination or table pages -->
        <div id="pagination"></div>
        <!-- Home Link -->
        <p><a href="/">Home</a></p>
        <!-- Buttons -->
        <div class="button-group">
            <button id="exportButton">Export to Excel</button>
        </div>
        <!-- Error/Success Message -->
        <p id="message" class="error-message"></p>
    </div>

    <!-- Custom Label -->
    <div id="labelContainer" style="display: none;">
        <h3>NON-CONFORMANCE</h3>
        <p><strong>Technician:</strong> <span id="labelTechnician"></span></p>
        <p><strong>Date:</strong> <span id="labelDate"></span></p>
        <p><strong>Part Number:</strong> <span id="labelPartNumber"></span></p>
        <p><strong>Quantity:</strong><span id="labelquantity"></span></p>
        <p><strong>Issue Comments:</strong> <span id="labelIssueComments"></span></p>
        <p><strong>Resolution ID:</strong> <span id="labelResolutionId"></span></p>
    </div>

    <!-- Add SheetJS library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js"></script>
    <script>
        let originalRecordsData = [];
        let filteredRecordsData = [];
        let currentPage = 1;
        const recordsPerPage = 10;

        // Load records when the DOM is ready
        document.addEventListener('DOMContentLoaded', () => loadRecords());

        // Function to load resolved records from the server
        async function loadRecords() {
            try {
                const response = await fetch('/resolvedRecords'); 
                if (!response.ok) {
                    throw new Error(`Failed to fetch resolved records: ${response.status} ${response.statusText}`);
                }
                const records = await response.json();
                originalRecordsData = records;
                filteredRecordsData = records;
                renderRecords();
            } catch (error) {
                console.error(error.message);
                displayMessage(error.message, true);
            }
        }

        // Function to render records in the table
        function renderRecords() {
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const recordsToDisplay = filteredRecordsData.slice(startIndex, endIndex);
            populateTable(recordsToDisplay);
            renderPagination();
        }

        // Function to render pagination buttons
        function renderPagination() {
            const totalPages = Math.ceil(filteredRecordsData.length / recordsPerPage);
            const paginationElement = document.getElementById('pagination');
            paginationElement.innerHTML = '';

            if (totalPages > 1) {
                for (let i = 1; i <= totalPages; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.addEventListener('click', () => {
                        currentPage = i;
                        renderRecords();
                    });
                    paginationElement.appendChild(button);
                }
            }
        }

        // Function to populate the table with records
        function populateTable(records) {
            const tableBody = document.querySelector('#ResolvedRecordsTable tbody');
            tableBody.innerHTML = '';
            records.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" value="${record.id}"></td>
                    <td>${record.resolutionId}</td>
                    <td>${record.date}</td>
                    <td>${record.technician}</td>
                    <td>${record.partNumber}</td>
                    <td>${record.productLine}</td>
                    <td>${record.batchNumber}</td>
                    <td>${record.quantity}</td>
                    <td>${record.issue}</td>
                    <td>${record.issueComments}</td>
                    <td>${record.resolutionComment}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Function to display a message
        function displayMessage(message, isError) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = message;
            messageElement.style.color = isError ? 'red' : 'green';
        }

        // Event listener for "Select All" checkbox
        document.getElementById('selectAll').addEventListener('change', function () {
            const checkboxes = document.querySelectorAll('#ResolvedRecordsTable input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = this.checked);
        });

        // Function to search the table
        function searchTable(field) {
            const searchValue = document.getElementById(`search${field.charAt(0).toUpperCase() + field.slice(1)}`).value.toLowerCase();
            filteredRecordsData = originalRecordsData.filter(record => record[field].toLowerCase().includes(searchValue));
            currentPage = 1;
            renderRecords();
        }

        // Event listener for "Export to Excel" button
        document.getElementById('exportButton').addEventListener('click', exportTableToExcel);

        // Function to export table data to Excel
        function exportTableToExcel() {
            const selectedRecords = originalRecordsData;

            if (selectedRecords.length > 0) {
                const ws = XLSX.utils.json_to_sheet(selectedRecords);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Records');
                XLSX.writeFile(wb, 'all_records.xlsx');
            } else {
                displayMessage('No records available for export.', true);
            }
        }
    </script>
</body>
</html>
